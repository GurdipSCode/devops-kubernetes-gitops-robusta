# =============================================================================
# ApplicationSet for Multi-Environment Monitoring
# =============================================================================
# This creates monitoring stacks for multiple environments/clusters
# automatically based on the generator configuration.
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: k3s-monitoring-envs
  namespace: argocd
spec:
  generators:
    # List generator for multiple environments
    - list:
        elements:
          - env: dev
            cluster: https://kubernetes.default.svc
            namespace: monitoring-dev
            victoriaMetricsIP: "192.168.1.100"
            retention: "7d"
            storageSize: "10Gi"
          - env: staging
            cluster: https://kubernetes.default.svc
            namespace: monitoring-staging
            victoriaMetricsIP: "192.168.1.101"
            retention: "30d"
            storageSize: "20Gi"
          - env: prod
            cluster: https://kubernetes.default.svc
            namespace: monitoring-prod
            victoriaMetricsIP: "192.168.1.102"
            retention: "90d"
            storageSize: "50Gi"

  template:
    metadata:
      name: 'robusta-{{env}}'
      namespace: argocd
      labels:
        app.kubernetes.io/name: robusta
        app.kubernetes.io/env: '{{env}}'
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      sources:
        # Robusta Helm chart
        - repoURL: https://robusta-charts.storage.googleapis.com
          chart: robusta
          targetRevision: 0.12.*
          helm:
            releaseName: 'robusta-{{env}}'
            valuesObject:
              clusterName: 'k3s-{{env}}'
              
              enablePrometheusStack: true
              enableServiceMonitors: true
              
              kube-prometheus-stack:
                prometheus:
                  prometheusSpec:
                    retention: '{{retention}}'
                    storageSpec:
                      volumeClaimTemplate:
                        spec:
                          accessModes: ["ReadWriteOnce"]
                          resources:
                            requests:
                              storage: '{{storageSize}}'
                    remoteWrite:
                      - url: 'http://{{victoriaMetricsIP}}:8428/api/v1/write'
                        queueConfig:
                          capacity: 50000
                          maxSamplesPerSend: 10000
                        writeRelabelConfigs:
                          - sourceLabels: [__name__]
                            targetLabel: cluster
                            replacement: 'k3s-{{env}}'
                          - sourceLabels: [__name__]
                            targetLabel: environment
                            replacement: '{{env}}'
                
                grafana:
                  enabled: true
                  adminPassword: '${GRAFANA_ADMIN_PASSWORD}'
                  
                alertmanager:
                  enabled: false
              
              runner:
                resources:
                  requests:
                    cpu: 100m
                    memory: 512Mi
            
            # Reference secrets from external source
            valueFiles:
              - $values/overlays/{{env}}/robusta-secrets.yaml
        
        # Values from Git repository
        - repoURL: https://github.com/YOUR_ORG/k3s-monitoring.git
          targetRevision: HEAD
          ref: values

      destination:
        server: '{{cluster}}'
        namespace: '{{namespace}}'
      
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
        retry:
          limit: 5
          backoff:
            duration: 10s
            factor: 2
            maxDuration: 5m
      
      ignoreDifferences:
        - group: ""
          kind: Secret
          jsonPointers:
            - /data

---
# ApplicationSet for PrometheusRules per environment
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: prometheus-rules-envs
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - env: dev
            namespace: monitoring-dev
          - env: staging
            namespace: monitoring-staging
          - env: prod
            namespace: monitoring-prod
  
  template:
    metadata:
      name: 'prometheus-rules-{{env}}'
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://github.com/YOUR_ORG/k3s-monitoring.git
        targetRevision: HEAD
        path: 'overlays/{{env}}/prometheus-rules'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
